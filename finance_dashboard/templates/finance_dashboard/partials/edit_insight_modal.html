<div class="modal fade" id="editInsightModal" tabindex="-1" aria-labelledby="editInsightModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editInsightModalLabel">Edit Insight: {{ insight.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="POST" action="{% url 'edit_insight' insight.pk %}" enctype="multipart/form-data" id="editInsightForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="id_title" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="id_title" name="title" value="{{ insight.title }}" required>
                    </div>

                    <div class="mb-3">
                        <label for="id_summary" class="form-label">Summary *</label>
                        <textarea class="form-control" id="id_summary" name="summary" rows="3" required>{{ insight.summary }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="id_category" class="form-label">Category *</label>
                        <select class="form-select" id="id_category" name="category" required>
                            <option value="currency" {% if insight.category == 'currency' %}selected{% endif %}>Currency</option>
                            <option value="stock" {% if insight.category == 'stock' %}selected{% endif %}>Stock</option>
                            <option value="summary" {% if insight.category == 'summary' %}selected{% endif %}>Summary</option>
                            <option value="other" {% if insight.category == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="id_result" class="form-label">Result *</label>
                        <select class="form-select" id="id_result" name="result" required>
                            <option value="positive" {% if insight.result == 'positive' %}selected{% endif %}>Positive</option>
                            <option value="negative" {% if insight.result == 'negative' %}selected{% endif %}>Negative</option>
                            <option value="neutral" {% if insight.result == 'neutral' %}selected{% endif %}>Neutral</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="id_reason" class="form-label">Reason</label>
                        <textarea class="form-control" id="id_reason" name="reason" rows="3">{{ insight.reason }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="id_analysis" class="form-label">Analysis</label>
                        <textarea class="form-control" id="id_analysis" name="analysis" rows="3">{{ insight.analysis }}</textarea>
                    </div>

                    <div class="mb-3">
                        <label for="id_lessons" class="form-label">Lessons</label>
                        <textarea class="form-control" id="id_lessons" name="lessons" rows="3">{{ insight.lessons }}</textarea>
                    </div>

                    <!-- Hiển thị file đính kèm hiện tại -->
                    {% if insight.has_attachment %}
                    <div class="mb-3">
                        <label class="form-label">Current Attachment</label>
                        <div class="border p-2 rounded bg-light">
                            {% if insight.is_image %}
                                <img src="{{ insight.attached_image.url }}" 
                                     alt="Current image" 
                                     style="max-width: 200px; max-height: 150px;"
                                     class="img-fluid rounded">
                                <div class="mt-1">
                                    <small class="text-muted">{{ insight.file_name }}</small>
                                </div>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file me-2"></i>
                                    <div>
                                        <strong>{{ insight.file_name }}</strong>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" name="remove_attachment" id="remove_attachment" value="true">
                            <label class="form-check-label" for="remove_attachment">
                                Remove current attachment
                            </label>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Upload file mới -->
                    <div class="mb-3">
                        <label for="id_attached_image" class="form-label">Attach New Image (PNG, JPG, etc.)</label>
                        <input type="file" class="form-control" id="id_attached_image" name="attached_image" accept=".png,.jpg,.jpeg,.gif,.bmp">
                        <div class="form-text">Leave empty to keep current file</div>
                    </div>

                    <div class="mb-3">
                        <label for="id_attached_file" class="form-label">Or Attach New File (PDF, TXT, etc.)</label>
                        <input type="file" class="form-control" id="id_attached_file" name="attached_file" accept=".pdf,.txt,.doc,.docx">
                        <div class="form-text">Leave empty to keep current file</div>
                    </div>

                    <div class="mb-3">
                        <label for="id_metrics" class="form-label">Metrics (JSON format)</label>
                        <textarea class="form-control" id="id_metrics" name="metrics" rows="2" placeholder='{"pnl": 100, "drawdown": 5}'>{% if insight.metrics %}{{ insight.metrics }}{% endif %}</textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitEditForm()">
                    <i class="fas fa-save me-1"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Tự động hiển thị modal khi được load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Edit modal loaded, showing modal...');
    const editModal = new bootstrap.Modal(document.getElementById('editInsightModal'));
    editModal.show();
});

function submitEditForm() {
    const form = document.getElementById('editInsightForm');
    const formData = new FormData(form);
    
    console.log('Submitting edit form...');
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Edit successful, reloading page...');
            // Đóng modal và reload trang
            const modal = bootstrap.Modal.getInstance(document.getElementById('editInsightModal'));
            modal.hide();
            location.reload();
        } else {
            console.error('Edit error:', data.errors);
            alert('Error updating insight: ' + (data.errors || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating insight: ' + error);
    });
}

// Xử lý khi chọn remove attachment thì disable file inputs
const removeCheckbox = document.getElementById('remove_attachment');
const imageInput = document.getElementById('id_attached_image');
const fileInput = document.getElementById('id_attached_file');

if (removeCheckbox) {
    removeCheckbox.addEventListener('change', function() {
        if (this.checked) {
            if (imageInput) imageInput.disabled = true;
            if (fileInput) fileInput.disabled = true;
        } else {
            if (imageInput) imageInput.disabled = false;
            if (fileInput) fileInput.disabled = false;
        }
    });
}
</script>